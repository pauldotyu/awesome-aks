# Helm provider configuration with kubelogin and service principal

This repository contains an example of provisioning an AKS cluster with Azure RBAC enabled and using a service principal to authenticate with the cluster then installing Helm charts using a token generated by `kubelogin`.

## Prerequisites

- An Azure subscription
- Azure CLI
- Terraform CLI
- kubectl CLI

## Deployment Steps

1. **Clone the Repository**: Start by cloning this repository to your local machine.

   ```bash
   git clone ...
   cd 2025-11-24-helm-provider-with-kubelogin-and-spn
   ```

2. **Configure Azure CLI**: Log in to your Azure account using the Azure CLI.

   ```bash
   az login
   ```

3. Create a service principal with the necessary permissions to manage the AKS cluster.

   ```bash
   read -r CLIENT_ID CLIENT_SECRET TENANT_ID <<< \
     "$(az ad sp create-for-rbac \
        --name my-aks-spn \
        --query '{appId:appId, password:password, tenant:tenant}' -o tsv)"
   ```

4. Retrieve the object ID of the service principal.

   ```bash
   SERVICE_PRINCIPAL_OBJECT_ID=$(az ad sp show --id $CLIENT_ID --query id -o tsv)
   ```

5. **Create `main.auto.tfvars` File**: Create a `main.auto.tfvars` file in the root of the cloned repository and populate it with the service principal details.

   ```bash
   cat <<EOF > main.auto.tfvars
   service_principal_tenant_id="$TENANT_ID"
   service_principal_object_id="$SERVICE_PRINCIPAL_OBJECT_ID"
   service_principal_client_id="$CLIENT_ID"
   service_principal_client_secret="$CLIENT_SECRET"
   EOF
   ```

6. **Initialize Terraform**: Navigate to the directory containing the Terraform configuration files and initialize Terraform.

   ```bash
   terraform init
   ```

7. **Review and Modify Variables**: Review the `variables.tf` file and modify any variables as needed for your deployment.

8. **Plan the Deployment**: Run the Terraform plan command to see the resources that will be created.

   ```bash
   terraform plan 
   ```

9. **Apply the Configuration**: Apply the Terraform configuration to deploy the AKS Automatic cluster.

   ```bash
   terraform apply
   ```

   When prompted, type `yes` to confirm the deployment.

10. **Verify the Deployment**: Once the deployment is complete, connect to the AKS Automatic cluster to verify that it is running correctly.

   ```bash
   az aks get-credentials \
     --resource-group $(terraform output -raw rg_name) \
     --name $(terraform output -raw aks_name)
   ```

11. **Convert the kubeconfig**: The kubeconfig file needs to be converted to use the service principal for authentication.

   ```bash
   kubelogin convert-kubeconfig --login spn --server-id 6dae42f8-4368-4678-94ff-3960e28e3630 --client-id $CLIENT_ID --client-secret $CLIENT_SECRET --tenant-id $TENANT_ID
   ```

12. **Verify that you can access the cluster**: Use kubectl to verify that you can access the cluster using the service principal.

   ```bash
   kubectl get all
   ```

## Cleanup

To delete the resources created by this deployment, run the following command:

```bash
terraform destroy -auto-approve
az ad sp delete --id $CLIENT_ID
```

This will remove all resources defined in the Terraform configuration.

## Additional Resources

- [AKS Automatic Documentation](https://learn.microsoft.com/azure/aks/intro-aks-automatic)
- [Azure Verified Modules (AVM) Documentation](https://learn.microsoft.com/community/content/azure-verified-modules)
